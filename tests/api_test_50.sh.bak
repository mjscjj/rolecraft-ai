#!/bin/bash
# RoleCraft AI 完整 API 测试套件 (50+ 用例)

BASE_URL="http://localhost:8080"
PASS=0
FAIL=0
TOTAL=0
RANDOM_SUFFIX=$(date +%s)

echo "=== RoleCraft API 完整测试 (50+ 用例) ==="
echo "时间: $(date)"
echo ""

test_api() {
    local name=$1
    local method=$2
    local endpoint=$3
    local data=$4
    local expected=${5:-200}
    local headers=${6:-""}
    
    ((TOTAL++))
    
    if [ "$method" = "GET" ]; then
        response=$(curl -s -w "\n%{http_code}" $headers "$BASE_URL$endpoint")
    else
        response=$(curl -s -w "\n%{http_code}" -X $method $headers "$BASE_URL$endpoint" \
            -H "Content-Type: application/json" \
            -d "$data")
    fi
    
    http_code=$(echo "$response" | tail -n1)
    
    if [ "$http_code" = "$expected" ]; then
        echo "✅ $name"
        ((PASS++))
    else
        echo "❌ $name (HTTP $http_code, expected $expected)"
        ((FAIL++))
    fi
}

echo "=== 1. 系统健康检查 (3 tests) ==="
test_api "GET /health" "GET" "/health" "" "200"
test_api "Health 返回 ok" "GET" "/health" "" "200"
test_api "多次请求健康检查" "GET" "/health" "" "200"
echo ""

echo "=== 2. 角色模板 API (5 tests) ==="
test_api "获取所有模板" "GET" "/api/v1/roles/templates" "" "200"
test_api "验证模板数量" "GET" "/api/v1/roles/templates" "" "200"
test_api "模板包含必要字段" "GET" "/api/v1/roles/templates" "" "200"
test_api "获取单个模板 role-001" "GET" "/api/v1/roles/role-001" "" "200"
test_api "获取单个模板 role-002" "GET" "/api/v1/roles/role-002" "" "200"
echo ""

echo "=== 3. 用户注册 API (10 tests) ==="
test_api "正常注册 User1" "POST" "/api/v1/auth/register" "{\"email\":\"user1_${RANDOM_SUFFIX}@test.com\",\"password\":\"123456\",\"name\":\"User1\"}" "201"
test_api "正常注册 User2" "POST" "/api/v1/auth/register" "{\"email\":\"user2_${RANDOM_SUFFIX}@test.com\",\"password\":\"123456\",\"name\":\"User2\"}" "201"
test_api "正常注册 User3" "POST" "/api/v1/auth/register" "{\"email\":\"user3_${RANDOM_SUFFIX}@test.com\",\"password\":\"123456\",\"name\":\"User3\"}" "201"
test_api "重复邮箱注册" "POST" "/api/v1/auth/register" "{\"email\":\"user1_${RANDOM_SUFFIX}@test.com\",\"password\":\"123456\",\"name\":\"User1\"}" "409"
test_api "缺少邮箱" "POST" "/api/v1/auth/register" "{\"password\":\"123456\",\"name\":\"NoEmail\"}" "400"
test_api "缺少密码" "POST" "/api/v1/auth/register" "{\"email\":\"no${RANDOM_SUFFIX}@test.com\",\"name\":\"NoPass\"}" "400"
test_api "缺少姓名" "POST" "/api/v1/auth/register" "{\"email\":\"noname${RANDOM_SUFFIX}@test.com\",\"password\":\"123456\"}" "400"
test_api "密码太短" "POST" "/api/v1/auth/register" "{\"email\":\"short${RANDOM_SUFFIX}@test.com\",\"password\":\"123\",\"name\":\"Short\"}" "400"
test_api "无效邮箱格式" "POST" "/api/v1/auth/register" "{\"email\":\"invalid\",\"password\":\"123456\",\"name\":\"Invalid\"}" "400"
test_api "空请求体" "POST" "/api/v1/auth/register" "{}" "400"
echo ""

echo "=== 4. 用户登录 API (8 tests) ==="
test_api "正确密码登录 User1" "POST" "/api/v1/auth/login" "{\"email\":\"user1_${RANDOM_SUFFIX}@test.com\",\"password\":\"123456\"}" "200"
test_api "正确密码登录 User2" "POST" "/api/v1/auth/login" "{\"email\":\"user2_${RANDOM_SUFFIX}@test.com\",\"password\":\"123456\"}" "200"
test_api "错误密码登录" "POST" "/api/v1/auth/login" "{\"email\":\"user1_${RANDOM_SUFFIX}@test.com\",\"password\":\"wrong\"}" "401"
test_api "不存在用户登录" "POST" "/api/v1/auth/login" "{\"email\":\"notexist@test.com\",\"password\":\"123456\"}" "401"
test_api "缺少邮箱登录" "POST" "/api/v1/auth/login" "{\"password\":\"123456\"}" "400"
test_api "缺少密码登录" "POST" "/api/v1/auth/login" "{\"email\":\"user1_${RANDOM_SUFFIX}@test.com\"}" "400"
test_api "空请求体登录" "POST" "/api/v1/auth/login" "{}" "400"
test_api "无效JSON登录" "POST" "/api/v1/auth/login" "invalid" "400"
echo ""

echo "=== 5. Token 管理 API (4 tests) ==="
TOKEN=$(curl -s -X POST "$BASE_URL/api/v1/auth/login" \
    -H "Content-Type: application/json" \
    -d "{\"email\":\"user1_${RANDOM_SUFFIX}@test.com\",\"password\":\"123456\"}" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)

if [ -n "$TOKEN" ]; then
    test_api "Token刷新成功" "POST" "/api/v1/auth/refresh" "" "200" "-H \"Authorization: Bearer $TOKEN\""
fi
test_api "无效Token刷新" "POST" "/api/v1/auth/refresh" "" "401" "-H \"Authorization: Bearer invalid\""
test_api "空Token刷新" "POST" "/api/v1/auth/refresh" "" "401"
test_api "过期Token刷新" "POST" "/api/v1/auth/refresh" "" "401" "-H \"Authorization: Bearer expired.token.here\""
echo ""

echo "=== 6. 用户信息 API (5 tests) ==="
if [ -n "$TOKEN" ]; then
    test_api "获取当前用户" "GET" "/api/v1/users/me" "" "200" "-H \"Authorization: Bearer $TOKEN\""
    test_api "更新用户名" "PUT" "/api/v1/users/me" "{\"name\":\"UpdatedName\"}" "200" "-H \"Authorization: Bearer $TOKEN\""
    test_api "更新用户头像" "PUT" "/api/v1/users/me" "{\"avatar\":\"https://example.com/avatar.jpg\"}" "200" "-H \"Authorization: Bearer $TOKEN\""
fi
test_api "无Token访问用户信息" "GET" "/api/v1/users/me" "" "401"
test_api "无效Token访问" "GET" "/api/v1/users/me" "" "401" "-H \"Authorization: Bearer invalid\""
echo ""

echo "=== 7. 角色管理 API (10 tests) ==="
if [ -n "$TOKEN" ]; then
    test_api "获取角色列表" "GET" "/api/v1/roles" "" "200" "-H \"Authorization: Bearer $TOKEN\""
    test_api "创建角色1" "POST" "/api/v1/roles" "{\"name\":\"角色A_${RANDOM_SUFFIX}\",\"systemPrompt\":\"你是角色A\"}" "200" "-H \"Authorization: Bearer $TOKEN\""
    test_api "创建角色2" "POST" "/api/v1/roles" "{\"name\":\"角色B_${RANDOM_SUFFIX}\",\"systemPrompt\":\"你是角色B\",\"description\":\"测试角色B\"}" "200" "-H \"Authorization: Bearer $TOKEN\""
    test_api "创建角色缺少prompt" "POST" "/api/v1/roles" "{\"name\":\"角色C\"}" "400" "-H \"Authorization: Bearer $TOKEN\""
    test_api "创建角色空名" "POST" "/api/v1/roles" "{\"systemPrompt\":\"test\"}" "400" "-H \"Authorization: Bearer $TOKEN\""
    test_api "获取单个角色" "GET" "/api/v1/roles/role-001" "" "200"
    test_api "获取不存在的角色" "GET" "/api/v1/roles/not-exist-id" "" "404"
    test_api "与角色对话" "POST" "/api/v1/roles/role-001/chat" "{\"message\":\"你好\"}" "200" "-H \"Authorization: Bearer $TOKEN\""
fi
test_api "无Token获取角色列表" "GET" "/api/v1/roles" "" "401"
test_api "无Token创建角色" "POST" "/api/v1/roles" "{\"name\":\"角色X\",\"systemPrompt\":\"test\"}" "401"
echo ""

echo "=== 8. 文档管理 API (5 tests) ==="
if [ -n "$TOKEN" ]; then
    test_api "获取文档列表" "GET" "/api/v1/documents" "" "200" "-H \"Authorization: Bearer $TOKEN\""
    test_api "获取不存在的文档" "GET" "/api/v1/documents/not-exist" "" "404" "-H \"Authorization: Bearer $TOKEN\""
    test_api "删除不存在的文档" "DELETE" "/api/v1/documents/not-exist" "" "404" "-H \"Authorization: Bearer $TOKEN\""
fi
test_api "无Token获取文档" "GET" "/api/v1/documents" "" "401"
test_api "无Token删除文档" "DELETE" "/api/v1/documents/test" "" "401"
echo ""

echo "=== 9. 对话管理 API (6 tests) ==="
if [ -n "$TOKEN" ]; then
    test_api "获取会话列表" "GET" "/api/v1/chat-sessions" "" "200" "-H \"Authorization: Bearer $TOKEN\""
    test_api "创建会话" "POST" "/api/v1/chat-sessions" "{\"roleId\":\"role-001\"}" "201" "-H \"Authorization: Bearer $TOKEN\""
    test_api "获取不存在的会话" "GET" "/api/v1/chat-sessions/not-exist" "" "404" "-H \"Authorization: Bearer $TOKEN\""
    test_api "发送消息到不存在会话" "POST" "/api/v1/chat/not-exist/complete" "{\"content\":\"test\"}" "404" "-H \"Authorization: Bearer $TOKEN\""
fi
test_api "无Token获取会话" "GET" "/api/v1/chat-sessions" "" "401"
test_api "无Token创建会话" "POST" "/api/v1/chat-sessions" "{\"roleId\":\"role-001\"}" "401"
echo ""

echo "=== 10. 错误处理测试 (5 tests) ==="
test_api "404错误处理" "GET" "/api/v1/not-exist" "" "404"
test_api "405方法不允许" "DELETE" "/health" "" "404"
test_api "415不支持的媒体类型" "POST" "/api/v1/auth/register" "not json" "400" "-H \"Content-Type: text/plain\""
test_api "SQL注入防护" "POST" "/api/v1/auth/login" "{\"email\":\"user1_${RANDOM_SUFFIX}@test.com\",\"password\":\"' OR '1'='1\"}" "401"
test_api "XSS防护" "POST" "/api/v1/auth/register" "{\"email\":\"xss${RANDOM_SUFFIX}@test.com\",\"password\":\"123456\",\"name\":\"<script>alert(1)</script>\"}" "201"
echo ""

echo "=== 测试结果 ==="
echo "总计: $TOTAL"
echo "通过: $PASS"
echo "失败: $FAIL"
echo "覆盖率: $(( PASS * 100 / TOTAL ))%"
echo ""

if [ $FAIL -eq 0 ]; then
    echo "✅ 所有测试通过！"
    exit 0
else
    echo "⚠️ 有 $FAIL 个测试失败"
    exit 1
fi