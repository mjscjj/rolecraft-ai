# RoleCraft AI - 系统架构文档

> 技术架构详解

---

## 0. 模块层重构（2026-03）

当前业务分层以 4 个核心模块为主：

1. **对话**：同步协作与决策入口（`chat/agent` 双模式）
2. **我的公司**：组织级结果交付区（角色 + 成果聚合）
3. **角色市场**：角色能力安装入口（个人/公司）
4. **工作区**：异步任务中心（定时、每 N 小时、汇报、分析）

关键落地：

- 路由主入口升级为 `/workspaces`，兼容 `/works`
- `works` 表扩展调度与异步执行字段
- 公司详情接口新增成果聚合：`workspaceCount`、`outcomeCount`、`recentOutcomes`

详细字段与接口见：
- [模块重设计文档](./module-redesign-2026-03.md)
- [API 参考文档](./api-reference.md)

---

## 1. 系统架构概览

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      客户端层                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                  │
│  │  Web App │  │ Mobile   │  │ 第三方   │                  │
│  │  React   │  │  App     │  │  集成    │                  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘                  │
└───────┼─────────────┼─────────────┼─────────────────────────┘
        │             │             │ HTTPS/WSS
┌───────▼─────────────▼─────────────▼─────────────────────────┐
│                      API 网关层                               │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              Nginx / Kong API Gateway                 │  │
│  │  负载均衡 | 限流 | 认证 | SSL 终止                     │  │
│  └──────────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │
┌───────────────────────────▼─────────────────────────────────┐
│                      应用服务层                               │
│  ┌──────────────────────────────────────────────────────┐  │
│  │            RoleCraft Backend (Go + Gin)               │  │
│  ├──────────────────────────────────────────────────────┤  │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐        │  │
│  │  │ 认证   │ │ 角色   │ │ 对话   │ │ 知识库 │        │  │
│  │  │ 服务   │ │ 服务   │ │ 服务   │ │ 服务   │        │  │
│  │  └────────┘ └────────┘ └────────┘ └────────┘        │  │
│  └──────────────────────────────────────────────────────┘  │
└───────────────────────────┬─────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
┌───────▼───────┐  ┌───────▼───────┐  ┌───────▼───────┐
│   数据持久层   │  │    缓存层      │  │   文件存储层   │
│  PostgreSQL   │  │     Redis     │  │    MinIO      │
│  (主数据库)    │  │  (会话/缓存)   │  │  (对象存储)    │
└───────────────┘  └───────────────┘  └───────────────┘
        │
┌───────▼───────┐  ┌───────────────┐
│   向量数据库   │  │   AI 服务层    │
│   Milvus      │  │  OpenAI API   │
│  (语义检索)    │  │  Embedding    │
└───────────────┘  └───────────────┘
```

---

## 2. 技术栈选型

### 2.1 前端技术栈

| 层级 | 技术 | 版本 | 说明 |
|------|------|------|------|
| 框架 | React | 18.x | 组件化 UI |
| 语言 | TypeScript | 5.x | 类型安全 |
| 构建 | Vite | 5.x | 快速构建 |
| 路由 | React Router | 6.x | 客户端路由 |
| 状态 | Zustand | 4.x | 状态管理 |
| 数据 | TanStack Query | 5.x | 服务端状态 |
| UI | shadcn/ui | latest | 组件库 |
| 样式 | Tailwind CSS | 3.x | 原子化 CSS |

### 2.2 后端技术栈

| 层级 | 技术 | 版本 | 说明 |
|------|------|------|------|
| 语言 | Go | 1.21+ | 高性能 |
| Web 框架 | Gin | 1.9+ | HTTP 框架 |
| ORM | GORM | 1.25+ | 数据库 ORM |
| 验证 | Validator | latest | 参数验证 |
| 认证 | JWT | 5.x | Token 认证 |
| 日志 | Zap | latest | 高性能日志 |
| 文档 | Swaggo | latest | API 文档 |

### 2.3 基础设施

| 组件 | 技术 | 用途 |
|------|------|------|
| 数据库 | PostgreSQL 15 | 主数据库 |
| 缓存 | Redis 7 | 会话/缓存 |
| 向量 DB | Milvus | 语义检索 |
| 对象存储 | MinIO | 文件存储 |
| 消息队列 | RabbitMQ | 异步任务 |
| API 网关 | Nginx | 反向代理 |

---

## 3. 核心服务

### 3.1 认证服务

**职责：**
- 用户注册/登录
- Token 颁发和刷新
- 权限验证

**关键流程：**
```
用户登录 → 验证密码 → 生成 JWT → 返回 Token
         ↓
     存储会话到 Redis
```

### 3.2 角色服务

**职责：**
- 角色 CRUD
- 角色模板管理
- 角色配置

**数据流：**
```
前端请求 → API Gateway → 角色服务 → PostgreSQL
                                    ↓
                              返回角色数据
```

### 3.3 对话服务

**职责：**
- 对话会话管理
- 消息处理
- AI 集成
- 流式输出

**关键特性：**
- SSE 流式响应
- 上下文管理
- 知识库检索

### 3.4 知识库服务

**职责：**
- 文档上传
- 文本解析
- 向量化
- 检索增强

**处理流程：**
```
上传文档 → 格式解析 → 文本分块 → 向量化 → Milvus 存储
```

---

## 4. 项目结构

### 4.1 后端结构

```
backend/
├── cmd/
│   ├── server/          # 服务入口
│   └── migrate/         # 数据库迁移
├── internal/
│   ├── api/
│   │   ├── handler/     # API 处理器
│   │   └── middleware/  # 中间件
│   ├── models/          # 数据模型
│   ├── service/         # 业务逻辑
│   ├── repository/      # 数据访问
│   └── config/          # 配置管理
├── pkg/                 # 公共包
├── tests/               # 测试文件
└── docs/                # 文档
```

### 4.2 前端结构

```
frontend/
├── src/
│   ├── api/             # API 客户端
│   ├── components/      # UI 组件
│   ├── pages/           # 页面
│   ├── stores/          # 状态管理
│   ├── hooks/           # 自定义 Hooks
│   ├── types/           # TypeScript 类型
│   └── utils/           # 工具函数
├── public/              # 静态资源
└── tests/               # 测试文件
```

---

## 5. 关键设计

### 5.1 多租户架构

**隔离策略：**
- 数据隔离：workspace_id 字段
- 资源配额：独立限额
- 权限控制：RBAC 模型

### 5.2 缓存策略

**Redis 使用场景：**
- 会话存储（TTL: 2h）
- Token 黑名单
- 热点数据缓存
- 限流计数器

### 5.3 向量检索

**RAG 流程：**
```
用户问题 → Embedding → 向量检索 → Top-K 片段
                                    ↓
                            拼接到 Prompt → LLM → 回答
```

---

## 6. 安全设计

### 6.1 认证授权

- JWT Token 认证
- RBAC 权限模型
- API 密钥管理

### 6.2 数据安全

- 密码 bcrypt 加密
- 敏感数据加密存储
- HTTPS 传输加密

### 6.3 防护措施

- SQL 注入防护（ORM 参数化）
- XSS 防护（输入验证）
- CSRF 防护（Token 验证）
- 限流防护（Redis 计数器）

---

## 7. 性能优化

### 7.1 数据库优化

- 索引设计
- 查询优化
- 连接池配置

### 7.2 缓存优化

- 多级缓存
- 缓存预热
- 缓存失效策略

### 7.3 前端优化

- 代码分割
- 懒加载
- CDN 加速

---

*最后更新：2026-02-27*
